{% extends "base.html" %}
{% block title %}{{ ('GM Shield: ' ~ campaign.name) | trans }}{% endblock %}

{% block content %}
<script src="/static/js/campaign.js"></script>

<style>
.dashboard-top {
    border-bottom: 2px solid var(--ink);
    padding-bottom: 1rem;
    margin-bottom: 2rem;
}

.dashboard-title {
    text-align: center;
    margin-bottom: 1rem;
}

.dashboard-stats {
    display: flex;
    justify-content: space-around;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
}

.dashboard-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .dashboard-stats {
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }
    
    div[style*="grid-template-columns: 2fr 1fr"],
    div[style*="grid-template-columns: 3fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
}
</style>

<!-- TOP BAR: Title & Economy -->
<div class="dashboard-top">
    <div class="dashboard-title">
        <h1 style="margin: 0;">{{ campaign.name }}</h1>
        <small>{{ 'GM Dashboard' | trans }}</small>
    </div>
    
<!-- Stats Row -->
    <div class="dashboard-stats">
        <!-- Party Speed -->
        <div title="{{ 'Average Party Travel Speed' | trans }}" style="text-align: center;">
            <div style="font-size: 0.8rem;">{{ 'Party Speed' | trans }}</div>
            <span style="font-size: 1.5rem; font-weight: bold;">üêé {{ party_speed }}%</span>
        </div>

        <div title="{{ 'Total Gold in Party Treasury' | trans }}" style="text-align: center;">
            <div style="font-size: 0.8rem;">{{ 'Party Treasury' | trans }}</div>
            <span style="font-size: 1.5rem; color: #c5a004; font-weight: bold;">{{ campaign.party_gold }} üí∞</span>
        </div>
        
        <div title="{{ 'Weekly Maintenance Cost' | trans }}" style="text-align: center;">
            <div style="font-size: 0.8rem;">{{ 'Weekly Upkeep' | trans }}</div>
            <span style="font-size: 1.5rem; color: var(--accent); font-weight: bold;">-{{ campaign.upkeep_cost }} üí∞</span>
        </div>
        
        <div title="{{ 'Party Reputation Across the Lands' | trans }}" style="text-align: center;">
            <div style="font-size: 0.8rem;">{{ 'Renown' | trans }}</div>
            <span style="font-size: 1.5rem; font-weight: bold;">‚≠ê {{ campaign.renown | default(0) }}</span>
        </div>
    </div>
    
    <!-- Actions Row -->
    <div class="dashboard-actions">
        <button onclick="document.getElementById('settingsModal').style.display='block'" class="btn btn-small">
            ‚öôÔ∏è {{ 'Settings' | trans }}
        </button>
        
        {% if campaign.upkeep_cost > 0 %}
        <form action="/campaigns/{{ campaign._id }}/gold/pay_upkeep" method="POST" onsubmit="return confirm('{{ 'Pay ' ~ campaign.upkeep_cost ~ ' gold for weekly upkeep?' | trans }}');" style="margin: 0;">
            <button class="btn btn-small" style="background: #8a3324;" title="{{ 'Deduct upkeep from treasury' | trans }}">
                {{ 'Pay Upkeep' | trans }}
            </button>
        </form>
        {% endif %}
    </div>
</div>
<!-- End of Top Bar -->
<!-- === ROW 1: BATTLE SIMULATOR (Full Width) === -->
<div style="margin-bottom: 2rem; border: 3px solid #8a3324; padding: 1rem; background: rgba(0,0,0,0.05);">
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #8a3324; padding-bottom: 10px; margin-bottom: 10px;">
        <h2 style="margin: 0; color: #8a3324;">‚öîÔ∏è {{ 'Battle Simulator' | trans }}</h2>
        {% if campaign.combat_active %}
            <form action="/campaigns/{{ campaign._id }}/combat/end" method="POST" onsubmit="return confirm('{{ 'End Combat?' | trans }}');">
                <button class="btn btn-small" style="background: #666;">{{ 'End Combat' | trans }}</button>
            </form>
        {% endif %}
    </div>

    {% if not campaign.combat_active %}
    <!-- SETUP MODE (Keep existing setup code) -->
    <form action="/campaigns/{{ campaign._id }}/combat/start" method="POST">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <h4>{{ '1. Select Party Members' | trans }}</h4>
                {% for char in party %}
                <div>
                    <label>
                        <input type="checkbox" name="player_ids" value="{{ char._id }}" checked>
                        {{ char.name }} (Spd: {{ char.derived.current_speed }})
                    </label>
                </div>
                {% endfor %}
            </div>
            <div>
                <h4>{{ '2. Add Enemies' | trans }}</h4>
                <div id="enemy-container">
                    <select name="enemy_ids" style="margin-bottom: 5px;">
                        {% for mob in bestiary %}
                        <option value="{{ mob._id }}">{{ mob.name }} (HP: {{ mob.hp_max }})</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="button" onclick="duplicateEnemySelect()" class="btn btn-small">{{ '+ Add Another' | trans }}</button>
            </div>
        </div>
        <div style="text-align: center; margin-top: 1rem;">
            <button class="btn" style="background: #8a3324; font-size: 1.2rem;">{{ 'START BATTLE' | trans }}</button>
        </div>
    </form>

    {% else %}
    <!-- ACTIVE COMBAT MODE (Updated Layout) -->
    {% set sorted_combat = campaign.combatants | sort(attribute='action_points', reverse=True) %}
    {% set active_actor = sorted_combat[0] %}
    {% set is_ready = (active_actor.action_points >= 100) and (active_actor.hp_current > 0) %}

    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 2rem;">
        
        <!-- TURN ORDER -->
        <div>
            <table style="width: 100%; border-collapse: collapse;">
                <tr style="background: #ccc;">
                    <th>{{ 'Name' | trans }}</th>
                    <th>{{ 'HP' | trans }}</th>
                    <th>{{ 'Stam' | trans }}</th>
                    <th>{{ 'Action Bar' | trans }}</th>
                    <th>{{ 'AP' | trans }}</th>
                </tr>
                {% for c in sorted_combat %}
                <tr style="background: {{ '#ffe6e6' if c.type == 'Enemy' else '#e6fffa' }}; 
                           border-bottom: 1px solid #999; 
                           opacity: {{ '0.5' if c.hp_current <= 0 else '1' }};
                           {{ 'font-weight:bold; border: 2px solid #8a3324;' if loop.first and is_ready else '' }}">
                    <td style="padding: 5px;">
                        {{ c.name }} {{ 'üíÄ' if c.hp_current <= 0 else '' }}
                    </td>
                    <td style="text-align: center;">
                        <span style="color: {{ 'red' if c.hp_current == 0 else 'black' }}">{{ c.hp_current }}</span>
                    </td>
                    <td style="text-align: center; font-size: 0.9rem;">
                        {{ c.stamina_current }}
                    </td>
                    <td style="padding: 5px;">
                        <div style="background: #ddd; height: 10px; width: 100%; position: relative;">
                            <div style="background: {{ '#8a3324' if c.type == 'Enemy' else '#2196F3' }}; height: 100%; width: {{ [c.action_points, 100]|min }}%;"></div>
                        </div>
                    </td>
                    <td style="text-align: right; font-size: 0.8rem;">{{ c.action_points | int }}</td>
                </tr>
                {% endfor %}
            </table>

            {% if not is_ready %}
            <div style="text-align: center; margin-top: 1rem;">
                <form action="/campaigns/{{ campaign._id }}/combat/next" method="POST">
                    <button class="btn">{{ 'Next Tick' | trans }} ‚è©</button>
                </form>
            </div>
            {% endif %}
        </div>

        <!-- CONTROLS -->
        <div style="background: #fff; padding: 1rem; border: 1px solid #ccc; display: flex; flex-direction: column;">
            <div style="flex-grow: 1; border: 1px solid #eee; background: #f9f9f9; padding: 5px; margin-bottom: 10px; overflow-y: auto; max-height: 150px; font-size: 0.8rem;">
                {% for log in campaign.combat_log %}
                    {% if log.key is defined %}
                    <div style="border-bottom: 1px solid #eee;">{{ log.key | transp(log.params) }}</div>
                    {% else %}
                    <div style="border-bottom: 1px solid #eee;">{{ log }}</div>
                    {% endif %}
                {% endfor %}
            </div>

            {% if is_ready %}
            <h3 style="margin: 0 0 10px 0; color: #8a3324;">{{ ('Turn of {name}' | trans).replace('{name}', active_actor.name) }}</h3>

            {% if active_actor.is_ranged %}
            <div style="margin: 0 0 10px 0; font-size: 0.9rem; color: #555;">
                {{ 'Ammo' | trans }}: {{ active_actor.ammo_remaining if active_actor.ammo_remaining is not none else '‚Äî' }}
            </div>
            {% endif %}
            
            <form action="/campaigns/{{ campaign._id }}/combat/act" method="POST">
                <!-- Helper to find array index -->
                {% for c in campaign.combatants %}
                    {% if c.id == active_actor.id %}<input type="hidden" name="actor_index" value="{{ loop.index0 }}">{% endif %}
                {% endfor %}

                <select name="target_index" style="width: 100%; margin-bottom: 10px; padding: 5px;" required>
                    <option value="" disabled selected>{{ 'Select Target...' | trans }}</option>
                    {% for c in campaign.combatants %}
                        {% if c.hp_current > 0 %}
                        <option value="{{ loop.index0 }}">{{ c.name }} (HP: {{ c.hp_current }})</option>
                        {% endif %}
                    {% endfor %}
                </select>

                <!-- Bonuses -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px;">
                    <div>
                        <small>{{ 'Bonus Dmg' | trans }}</small>
                        <input type="number" name="bonus_dmg" value="0" style="width: 100%;">
                    </div>
                    <div>
                        <small>{{ 'Target Bonus Def' | trans }}</small>
                        <input type="number" name="bonus_def" value="0" style="width: 100%;">
                    </div>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label style="cursor: pointer;">
                        <input type="checkbox" name="is_crit" value="true"> {{ 'Critical Hit?' | trans }}
                    </label>
                </div>

                <!-- Action Buttons -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    <button name="action_type" value="Attack" class="btn" style="background: #8a3324;" {% if active_actor.is_ranged and (active_actor.ammo_remaining is not none) and active_actor.ammo_remaining <= 0 %}disabled title="{{ 'Out of ammo' | trans }}"{% endif %}>‚öîÔ∏è {{ 'Hit' | trans }}</button>
                    <button name="action_type" value="Miss" class="btn" style="background: #e6b800; color: #000;">üö´ {{ 'Miss' | trans }}</button>
                </div>
                <button name="action_type" value="Wait" class="btn btn-small" style="width: 100%; margin-top: 5px; background: #666;">{{ 'Wait (Delay)' | trans }}</button>
            </form>
            {% else %}
            <p style="text-align: center; color: #999;">{{ 'Waiting for tick...' | trans }}</p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- === ROW 2: MAP & TEST SIMULATOR (2/3 | 1/3) === -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 2rem;">
    
    <!-- MAP -->
    <div>
        <div id="map-container" style="position: relative; border: 3px solid var(--ink); width: 100%; cursor: crosshair; overflow: hidden; background: #000; height: 400px;">
            <img id="campaign-map" 
                 src="{{ campaign.map_url }}" 
                 onclick="openPinModal(event)"
                 style="width: 100%; height: 100%; object-fit: contain;">
            
            {% for pin in campaign.map_pins %}
                <div class="map-pin {{ pin.type|lower }}" 
                     style="left: {{ pin.x }}%; top: {{ pin.y }}%;"
                     title="{{ pin.label }}">
                    <div class="pin-dot"></div>
                    <div class="pin-label">
                        <strong>{{ pin.label }}</strong>
                        <form action="/campaigns/{{ campaign._id }}/map/pin/delete" method="POST">
                            <input type="hidden" name="pin_id" value="{{ pin.id }}">
                            <button class="btn-text" style="color: #ff0000; font-size: 0.7rem;">[X]</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- TEST SIMULATOR -->
    <div>
        <div style="background: var(--parchment); border: 2px solid var(--accent); padding: 1.5rem; height: 100%; box-sizing: border-box;">
            <h3 style="margin-top: 0; text-align: center; border-bottom: 1px solid var(--accent); padding-bottom: 10px;">‚öñÔ∏è {{ 'Test Simulator' | trans }}</h3>
            
            <div style="margin-bottom: 1rem;">
                <label><strong>{{ 'Action' | trans }}</strong></label>
                <select id="sim-action" onchange="updateSimulator()" style="width: 100%;">
                    {% for action in actions %}
                    <option value="{{ action.name }}"
                            data-attr-key="{{ action.attribute }}"
                            data-attr="{{ action.attribute | trans }}">
                        {{ action.name }}
                    </option>
                    {% endfor %}
                </select>
                <small id="sim-related-attr" style="display: block; text-align: right; color: #666;"></small>
            </div>

            <div style="margin-bottom: 1rem;">
                <label><strong>{{ 'Difficulty' | trans }}</strong></label>
                <select id="sim-difficulty" onchange="updateSimulator()" style="width: 100%;">
                    <option value="1">{{ 'Lvl' | trans }} 1 ({{ 'Trivial' | trans }})</option>
                    <option value="2">{{ 'Lvl' | trans }} 2 ({{ 'Easy' | trans }})</option>
                    <option value="3" selected>{{ 'Lvl' | trans }} 3 ({{ 'Medium' | trans }})</option>
                    <option value="4">{{ 'Lvl' | trans }} 4 ({{ 'Hard' | trans }})</option>
                    <option value="5">{{ 'Lvl' | trans }} 5 ({{ 'Legendary' | trans }})</option>
                </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label><strong>{{ 'Attribute' | trans }}</strong></label>
                <input type="number" id="sim-attribute-val" value="10" oninput="updateSimulator()" style="width: 100%;">
            </div>

            <div style="text-align: center; background: var(--ink); color: var(--parchment); padding: 1rem; border-radius: 4px;">
                <div>{{ 'Target (d20)' | trans }}</div>
                <div id="sim-result" style="font-size: 2.5rem; font-weight: bold; color: #c5a004;">5+</div>
            </div>
        </div>
    </div>
</div>

<!-- === ROW 3: PARTY & SCRATCHPAD (2/3 | 1/3) === -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    
    <!-- PARTY LIST -->
    <div style="overflow-x: auto;">
        <h3>{{ 'Active Party' | trans }}</h3>
        <table style="width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.4); min-width: 600px;">
            <tr style="background: var(--ink); color: var(--parchment);">
                <th style="padding: 10px; text-align: left;">{{ 'Character' | trans }}</th>
                <th>{{ 'HP' | trans }}</th>
                <th>{{ 'Stamina' | trans }}</th>
                <th>{{ 'Speed' | trans }}</th>
                <th>{{ 'Gold' | trans }}</th>
                <th>{{ 'Transfer' | trans }}</th>
            </tr>
            {% for char in party %}
            <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                <td style="padding: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <a href="/characters/{{ char._id }}" target="_blank" style="font-weight: bold; font-size: 1.1rem;">{{ char.name }}</a>
                        <button class="btn-text" 
                                onclick="openCampaignBio('{{ char.name|escape }}', this.getAttribute('data-bio'))"
                                data-bio="{{ char.public_bio }}" title="Read Bio">üìú</button>
                    </div>
                    <div style="font-size: 0.8rem; opacity: 0.7;">{{ char.class_archetype }}</div>
                </td>
                <td style="text-align: center;">
                    <span style="color: {{ 'red' if char.status.hp_current < 5 else 'inherit' }}">
                        {{ char.status.hp_current }}
                    </span> / {{ char.status.hp_max }}
                </td>
                <td style="text-align: center;">
                    {{ char.status.stamina }} <!-- NEW -->
                </td>
                <td style="text-align: center;">{{ char.derived.current_speed }}%</td>
                <td style="text-align: center; color: #c5a004; font-weight: bold;">{{ char.status.gold }}</td>
                <td style="text-align: center;">
                    <div style="display: flex; gap: 5px; justify-content: center;">
                        <button onclick="openTransfer('{{ char._id }}', '{{ char.name }}', 'in')" class="btn btn-small">‚Üì</button>
                        <button onclick="openTransfer('{{ char._id }}', '{{ char.name }}', 'out')" class="btn btn-small">‚Üë</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </table>
        
        <!-- PENDING REQUESTS -->
        {% set pending = campaign.members | selectattr("status", "equalto", "Pending") | list %}
        
        {% if pending %}
        <div style="margin-top: 2rem; border: 2px dashed var(--accent); padding: 1rem; background: rgba(138, 51, 36, 0.05); border-radius: 4px;">
            <h4 style="margin-top: 0; color: var(--accent); border-bottom: 1px solid var(--accent); padding-bottom: 5px;">
                ‚ö†Ô∏è {{ 'Pending Join Requests' | trans }}
            </h4>
            
            <ul style="list-style: none; padding: 0; margin: 0;">
                {% for req in pending %}
                <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1);">
                    <div>
                        <strong style="font-size: 1.1rem;">{{ req.character_name }}</strong>
                        <div style="font-size: 0.8rem; opacity: 0.7;">{{ 'wants to join the adventure.' | trans }}</div>
                    </div>
                    
                    <form action="/campaigns/{{ campaign._id }}/members/status" method="POST" style="display: flex; gap: 5px;">
                        <input type="hidden" name="char_id" value="{{ req.character_id }}">
                        
                        <button name="new_status" value="Accepted" class="btn btn-small" style="background: var(--ink); color: var(--parchment);">
                            {{ 'Accept' | trans }}
                        </button>
                        
                        <button name="new_status" value="Rejected" class="btn btn-small" style="background: transparent; color: #8a3324; border: 1px solid #8a3324;">
                            {{ 'Deny' | trans }}
                        </button>
                    </form>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <!-- SCRATCHPAD -->
    <div>
        <h3>{{ 'Session Notes' | trans }}</h3>
        <textarea style="width: 100%; height: 250px; resize: vertical; padding: 10px; border: 1px solid #8b7d6b; background: rgba(255,255,255,0.5);" placeholder="{{ 'Quick notes...' | trans }}"></textarea>
    </div>
</div>

<!-- MODAL: Settings -->
<div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="background: var(--parchment); width: 90%; max-width: 400px; margin: 15vh auto; padding: 2rem; border: 2px solid var(--ink);">
        <h3>{{ 'Campaign Settings' | trans }}</h3>
        <form action="/campaigns/{{ campaign._id }}/settings" method="POST">
            <label>{{ 'Map Image URL' | trans }}</label>
            <input type="text" name="map_url" value="{{ campaign.map_url }}" required>
            
            <label>{{ 'Weekly Upkeep Cost' | trans }}</label>
            <input type="number" name="upkeep" value="{{ campaign.upkeep_cost }}">
            
            <label>{{ 'Party Renown' | trans }}</label>
            <input type="number" name="renown" value="{{ campaign.renown | default(0) }}">
            
            <div style="margin-top: 1rem; display: flex; gap: 10px;">
                <button class="btn" style="flex: 1;">{{ 'Save' | trans }}</button>
                <button type="button" onclick="document.getElementById('settingsModal').style.display='none'" class="btn" style="background: #666;">{{ 'Cancel' | trans }}</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: Gold Transfer -->
<div id="transferModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="background: var(--parchment); width: 350px; margin: 20vh auto; padding: 2rem; border: 2px solid var(--ink);">
        <h3 id="transferTitle">{{ 'Transfer' | trans }}</h3>
        <p id="transferDesc"></p>
        
        <form action="/campaigns/{{ campaign._id }}/gold/transfer" method="POST">
            <input type="hidden" name="char_id" id="transferCharId">
            <!-- Amount: Positive = Char to Party. Negative = Party to Char -->
            <!-- We will handle sign via JS before submit or use two logic paths. 
                 Simpler: One input for amount, and a hidden field for direction multiplier. -->
            <input type="hidden" name="direction" id="transferDirection" value="1"> 
            
            <label>{{ 'Amount' | trans }}</label>
            <input type="number" name="raw_amount" id="transferAmount" required min="1">
            
            <div style="margin-top: 1rem; display: flex; gap: 10px;">
                <button type="button" onclick="submitTransfer()" class="btn" style="flex: 1;">{{ 'Confirm' | trans }}</button>
                <button type="button" onclick="document.getElementById('transferModal').style.display='none'" class="btn" style="background: #666;">{{ 'Cancel' | trans }}</button>
            </div>
        </form>
    </div>
</div>

    
<!-- MODAL: Add Map Pin -->
<div id="pinModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000;">
    <div style="background: var(--parchment); width: 300px; margin: 20vh auto; padding: 1.5rem; border: 2px solid var(--ink); position: relative;">
        <h3>{{ 'Add Map Pin' | trans }}</h3>
        <form action="/campaigns/{{ campaign._id }}/map/pin" method="POST">
            <!-- Hidden inputs for coordinates -->
            <input type="hidden" name="x" id="pinX">
            <input type="hidden" name="y" id="pinY">
            
            <label>{{ 'Label' | trans }}</label>
            <input type="text" name="label" placeholder="Party Location" required autofocus>
            
            <label>{{ 'Type' | trans }}</label>
            <select name="type" style="margin-bottom: 1rem;">
                <option value="Party">{{ 'Party (Blue)' | trans }}</option>
                <option value="Enemy">{{ 'Enemy (Red)' | trans }}</option>
                <option value="Location">{{ 'Location (Yellow)' | trans }}</option>
            </select>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="flex: 1;">{{ 'Place Pin' | trans }}</button>
                <button type="button" onclick="document.getElementById('pinModal').style.display='none'" class="btn" style="background: #666;">{{ 'Cancel' | trans }}</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: Campaign Character Bio -->
<div id="campBioModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000;">
    <div style="background: var(--parchment); width: 500px; margin: 20vh auto; padding: 2rem; border: 2px solid var(--ink); position: relative;">
        <button onclick="document.getElementById('campBioModal').style.display='none'" 
                style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
        
        <h2 id="campBioTitle" style="margin-top: 0; border-bottom: 2px solid var(--ink);"></h2>
        <div id="campBioContent" style="white-space: pre-wrap; font-family: 'Georgia', serif; line-height: 1.6; max-height: 50vh; overflow-y: auto;"></div>
    </div>
</div>

<style>
    /* Pin Container (Absolute positioned relative to map) */
    .map-pin {
        position: absolute;
        transform: translate(-50%, -50%); /* Center the dot on the coordinates */
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* The visual dot */
    .pin-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 0 5px rgba(0,0,0,0.8);
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .map-pin:hover .pin-dot { transform: scale(1.3); }

    /* Colors based on type */
    .party .pin-dot { background-color: #2196F3; } /* Blue */
    .enemy .pin-dot { background-color: #f44336; } /* Red */
    .location .pin-dot { background-color: #FFC107; } /* Yellow */

    /* The Tooltip/Label (Hidden by default, shown on hover) */
    .pin-label {
        display: none;
        position: absolute;
        bottom: 20px;
        background: rgba(0,0,0,0.8);
        color: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
        text-align: center;
        z-index: 20;
    }

    .map-pin:hover .pin-label { display: block; }
</style>

<script>
    // Initialize Simulator on Load
    updateSimulator();

    // Transfer Modal Logic
    function openTransfer(charId, charName, direction) {
        document.getElementById('transferModal').style.display = 'block';
        document.getElementById('transferCharId').value = charId;
        
        const title = document.getElementById('transferTitle');
        const desc = document.getElementById('transferDesc');
        const dirInput = document.getElementById('transferDirection');
        
        if (direction === 'in') {
            title.innerText = "{{ 'Collect Taxes / Fees' | trans }}";
            desc.innerText = `{{ 'Take gold FROM' | trans }} ${charName} {{ 'to Party Treasury.' | trans }}`;
            dirInput.value = "1"; // Positive
        } else {
            title.innerText = "{{ 'Distribute Loot' | trans }}";
            desc.innerText = `{{ 'Give gold TO' | trans }} ${charName} {{ 'from Treasury.' | trans }}`;
            dirInput.value = "-1"; // Negative
        }
    }

    function submitTransfer() {
        // We need to combine the raw amount with direction
        const form = document.querySelector('#transferModal form');
        const raw = document.getElementById('transferAmount').value;
        const dir = document.getElementById('transferDirection').value;
        
        // Create a hidden input for the final signed amount that the backend expects
        const hiddenAmt = document.createElement('input');
        hiddenAmt.type = 'hidden';
        hiddenAmt.name = 'amount';
        hiddenAmt.value = parseInt(raw) * parseInt(dir);
        form.appendChild(hiddenAmt);
        
        // Remove raw_amount so it doesn't confuse backend (optional if backend ignores extra fields)
        document.getElementById('transferAmount').removeAttribute('name');
        
        form.submit();
    }

    function openPinModal(event) {
        const mapImg = document.getElementById('campaign-map');
        const modal = document.getElementById('pinModal');
        const inputX = document.getElementById('pinX');
        const inputY = document.getElementById('pinY');

        // 1. Get click position relative to the image
        const rect = mapImg.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        // 2. Convert to Percentage (0-100)
        // This ensures pins stay correct if image resizes
        const xPercent = (x / rect.width) * 100;
        const yPercent = (y / rect.height) * 100;

        // 3. Set values and show modal
        inputX.value = xPercent.toFixed(2);
        inputY.value = yPercent.toFixed(2);
        
        modal.style.display = 'block';
        
        // Focus label input
        modal.querySelector('input[name="label"]').focus();
    }

    function openCampaignBio(name, bioText) {
        document.getElementById('campBioTitle').innerText = name;
        document.getElementById('campBioContent').innerText = bioText;
        document.getElementById('campBioModal').style.display = 'block';
    }

    function duplicateEnemySelect() {
        const container = document.getElementById('enemy-container');
        const select = container.querySelector('select').cloneNode(true);
        container.appendChild(select);
    }
</script>

{% endblock %}