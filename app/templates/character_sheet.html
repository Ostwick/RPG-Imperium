{% extends "base.html" %}
{% block title %}{{ character.name }}{% endblock %}

{% block content %}

<style>
    .char-header {
        display: flex;
        gap: 2rem;
        align-items: center;
        border-bottom: 3px solid var(--ink);
        padding-bottom: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .char-header-info {
        flex-grow: 1;
    }
    
    .char-header-points {
        text-align: right;
        min-width: 150px;
    }

    .char-header-photo {
        position: relative;
        width: 120px;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .char-photo-img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
        border-radius: 15px;
        border: 3px solid var(--accent);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        background: #333;
    }
    
    @media (max-width: 768px) {
        .char-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .char-header-top {
            display: flex;
            gap: 1rem;
            width: 100%;
            align-items: flex-start;
        }
        
        .char-header-photo {
            flex-shrink: 0;
        }
        
        .char-header-top-right {
            flex-grow: 1;
        }
        
        .char-header-info h1 {
            font-size: 1.8rem !important;
        }
        
        .char-header-points {
            text-align: left;
            min-width: auto;
            width: 100%;
        }
    }
</style>
    
<!-- HEADER: Photo, Details, Points -->
<div class="char-header">
    <div class="char-header-top">
        <!-- 1. Character Photo -->
        <div class="char-header-photo">
            <img src="{{ character.image_url }}" 
                 class="char-photo-img"
                 onerror="this.src='https://i.imgur.com/62jO8iC.png'">
            
            <button onclick="document.getElementById('photoModal').style.display='block'" 
                    title="Change Portrait"
                    style="position: absolute; bottom: -5px; right: -5px; background: var(--ink); color: #fff; border: 1px solid var(--parchment); border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">
                üì∑
            </button>
        </div>

        <!-- Top Right: Level & Gold -->
        <div class="char-header-top-right">
            <!-- LEVEL DISPLAY -->
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <div style="background: var(--ink); color: var(--parchment); padding: 5px 10px; border-radius: 4px; font-weight: bold; font-variant: small-caps;">
                    {{ 'Level' | trans }} {{ character.status.level }}
                </div>
                
                <!-- LEVEL UP BUTTON -->
                {% if is_gm and character.status.level < 20 %}
                <form action="/characters/{{ character._id }}/levelup" method="POST" onsubmit="return confirm('Level Up {{ character.name }} to {{ character.status.level + 1 }}?');">
                    <button class="btn btn-small" title="{{ 'Grant Level Up' | trans }}" style="background: var(--accent); border: 1px solid var(--ink);">‚ñ≤</button>
                </form>
                {% endif %}
            </div>
            
            <!-- Gold Display -->
            <div style="display: inline-flex; align-items: center; background: rgba(197, 160, 4, 0.1); border: 1px solid #c5a004; padding: 5px 15px; border-radius: 20px;">
                <span style="font-size: 1.5rem; margin-right: 5px;">üí∞</span>
                <span style="font-weight: bold; font-size: 1.3rem; color: var(--ink);">{{ character.status.gold }}</span>
                
                {% if is_gm %}
                <button onclick="document.getElementById('goldModal').style.display='block'" 
                        class="btn-text" 
                        style="margin-left: 10px; color: var(--accent); font-size: 0.8rem;">({{ 'Edit' | trans }})</button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 2. Character Info -->
    <div class="char-header-info">
        <h1 style="margin: 0; font-size: 2.5rem; letter-spacing: 1px;">{{ character.name }}</h1>

        <div style="font-size: 1.2rem; font-style: italic; color: var(--accent); margin-top: 5px;">
            <!-- Display Culture & Archetype -->
            <span>{{ character.culture }} - {{ character.class_archetype }}</span>
        </div>
        
        <!-- BIO BUTTON -->
        <button onclick="document.getElementById('bioModal').style.display='block'" class="btn-text" style="font-size: 0.9rem; border-bottom: 1px dashed var(--accent); cursor: pointer; margin-top: 5px; color: var(--accent);">
            üìñ {{ 'Read Bio' | trans }}
        </button>
    </div>

    <!-- 3. Points Counter -->
    <div class="char-header-points">
        <div style="margin-bottom: 5px;">
            <strong>{{ 'Attr Points:' | trans }}</strong> 
            <span style="font-size: 1.4rem; color: var(--accent); font-weight: bold;">{{ character.points.attribute_points }}</span>
        </div>
        <div>
            <strong>{{ 'Skill Points:' | trans }}</strong> 
            <span style="font-size: 1.4rem; color: var(--gold); font-weight: bold;">{{ character.points.skill_points }}</span>
        </div>
    </div>
</div>

<!-- STATS ROW -->
<div style="display: flex; justify-content: space-around; margin-bottom: 2rem; background: rgba(0,0,0,0.05); padding: 1rem; border-radius: 4px; border: 1px dashed #8b7d6b; flex-wrap: wrap; gap: 15px;">
    
    <!-- HP -->
    <div title="Health Points" style="display: flex; align-items: center; gap: 5px;">
        <span style="font-size: 1.2rem;">‚ù§Ô∏è</span> 
        <strong>{{ 'HP' | trans }}:</strong> {{ character.status.hp_current }} / {{ character.status.hp_max }}
        {% if is_gm %}
        <button onclick="openStatusModal()" class="btn-text" style="color: var(--accent); font-size: 0.8rem;">(Edit)</button>
        {% endif %}
    </div>

    <!-- Stamina -->
    <div title="Stamina">
        <span style="font-size: 1.2rem;">‚ö°</span> 
        <strong>{{ 'Stam' | trans }}:</strong> {{ character.status.stamina }} / {{ max_stamina }}
    </div>

        
    <!-- Speed -->
    <div title="Current Speed (Max: {{ max_speed }}%)">
        <span style="font-size: 1.2rem;">üêé</span> 
        <strong>{{ 'Spd' | trans }}:</strong> 
        <span style="color: {{ 'red' if speed < max_speed else 'inherit' }}">
            {{ speed }}%
        </span>
    </div>

    <!-- Combat Stats -->
    <div title="Calculated Attack Power">
        <span style="font-size: 1.2rem;">‚öîÔ∏è</span> 
        <strong>{{ 'Atk' | trans }}:</strong> {{ attack }}
    </div>
    
    <div title="Critical Damage Bonus">
        <span style="font-size: 1.2rem;">üí•</span> 
        <strong>{{ 'Crit' | trans }}:</strong> +{{ crit_bonus }}%
    </div>
    
    <div title="Calculated Defense">
        <span style="font-size: 1.2rem;">üõ°Ô∏è</span> 
        <strong>{{ 'Def' | trans }}:</strong> {{ defense }}
    </div>
    
    <!-- Weight -->
    <div title="Current Weight / Max Weight">
        <span style="font-size: 1.2rem;">‚öñÔ∏è</span> 
        <strong>{{ 'Load' | trans }}:</strong> 
        <span style="color: {{ 'red' if current_load > max_load else 'inherit' }}">
            {{ current_load }} / {{ max_load }} kg
        </span>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">

<style>
@media (max-width: 768px) {
    div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
}
</style>

    <!-- LEFT: ATTRIBUTES (Form for Editing) -->
    <div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>{{ 'Attributes' | trans }}</h3>
            {% if character.points.attribute_points > 0 and (is_owner or is_gm) %}
            <button type="button" onclick="toggleEdit()" class="btn btn-small" id="editBtn">{{ 'Edit / Spend Points' | trans }}</button>
            {% endif %}
        </div>

        <form action="/characters/{{ character._id }}/attributes/save" method="POST" id="attrForm">

            <!-- Hidden "Points Pool" tracker for JS -->
            <div class="edit-mode"
                style="display:none; background: #e3f2fd; color: #0d47a1; padding: 10px; margin-bottom: 10px; border-radius: 4px; text-align: center;">
                <strong>{{ 'Points Remaining' | trans }}: </strong>
                <span id="ui-points-remaining">{{ character.points.attribute_points }}</span>
            </div>

            <table style="width: 100%;">
                {% for attr_name, attr_data in character.stats.items() %}
                <tr>
                    <td style="padding: 8px;"><strong>{{ attr_name | trans }}</strong></td>
                    <td style="text-align: right;">

                        <!-- VIEW MODE -->
                        <span class="view-mode" style="font-weight: bold; font-size: 1.2rem;">{{ attr_data.value
                            }}</span>

                        <!-- EDIT MODE (Custom Controls) -->
                        <div class="edit-mode" style="display: none;">
                            <div style="display: inline-flex; align-items: center; gap: 5px;">
                                <!-- HIDDEN INPUT (Sent to Server) -->
                                <input type="hidden" id="input-{{ attr_name }}" name="{{ attr_name }}"
                                    value="{{ attr_data.value }}" data-original="{{ attr_data.value }}">

                                <!-- MINUS BUTTON -->
                                <button type="button" class="btn btn-small" style="padding: 2px 8px; background: #ccc;"
                                    onclick="adjustStat('{{ attr_name }}', -1)">-</button>

                                <!-- VISUAL NUMBER -->
                                <span id="display-{{ attr_name }}"
                                    style="font-weight: bold; width: 25px; text-align: center;">
                                    {{ attr_data.value }}
                                </span>

                                <!-- PLUS BUTTON -->
                                <button type="button" id="btn-plus-{{ attr_name }}" class="btn btn-small"
                                    style="padding: 2px 8px;" onclick="adjustStat('{{ attr_name }}', 1)">+</button>
                            </div>
                        </div>

                    </td>
                </tr>
                <!-- Skills List Row -->
                <tr>
                    <td colspan="2" style="padding-bottom: 10px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            {% for skill_name, skill_data in attr_data.skills.items() %}
                            <a href="/characters/{{ character._id }}/skills/{{ attr_name }}/{{ skill_name }}"
                                class="btn btn-small"
                                style="background: #fff; color: var(--ink); border: 1px solid #ccc; font-size: 0.8rem;">
                                {{ skill_name | trans }}
                                 <span
                                     style="background: var(--ink); color: #fff; border-radius: 50%; padding: 0 4px; font-size: 0.7rem;">
                                     {{ skill_data.nodes_unlocked | length }}
                                 </span>
                             </a>
                             {% endfor %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </table>

            <div class="edit-mode" style="display: none; margin-top: 1rem; text-align: center;">
                <button type="submit" class="btn" id="confirmBtn">{{ 'Confirm Changes' | trans }}</button>
                <button type="button" onclick="cancelEdit()" class="btn" style="background: #666;">{{ 'Cancel' | trans }}</button>
            </div>
        </form>
    </div>

    <!-- RIGHT: EQUIPMENT & INVENTORY -->
    <div>
        <!-- EQUIPMENT SECTION -->
        <h3 style="border-bottom: 2px solid var(--ink); margin-bottom: 1rem;">{{ 'Equipment' | trans }}</h3>
        
        <div style="background: rgba(255,255,255,0.3); border: 1px solid #8b7d6b; padding: 1rem; margin-bottom: 2rem;">
            
                
<!-- ROW 1: HANDS -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                
                <!-- MAIN HAND -->
                <div class="equip-slot">
                    <small>{{ 'Main Hand' | trans }}</small>
                    {% if character.equipment.hand_main %}
                        <div class="item-box">
                            <div>
                                <strong>{{ character.equipment.hand_main.name }}</strong>
                                <div style="font-size: 0.7rem;">
                                    Dmg: {{ character.equipment.hand_main.damage }}
                                    {% if character.equipment.hand_main.weapon_type == 'Throwing' %}
                                        {{'Qty' | trans}}: {{ character.equipment.hand_main.quantity }}
                                    {% endif %}
                                </div>
                            </div>
                            {% if is_owner or is_gm %}
                            <form action="/characters/{{ character._id }}/unequip" method="POST">
                                <input type="hidden" name="slot" value="main">
                                <button class="btn-text">‚úï</button>
                            </form>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="empty-slot">{{ 'Empty' | trans }}</div>
                    {% endif %}
                </div>

                <!-- OFF HAND -->
                <div class="equip-slot">
                    <small>{{ 'Off Hand' | trans }}</small>
                    {% if character.equipment.hand_off %}
                        <div class="item-box">
                            <div>
                                <strong>{{ character.equipment.hand_off.name }}</strong>
                                <div style="font-size: 0.7rem;">
                                    <!-- LOGIC: Throwing vs Weapon vs Ammo vs Shield -->
                                    {% if character.equipment.hand_off.weapon_type == 'Throwing' %}
                                        {{'Dmg' | trans}}: {{ character.equipment.hand_off.damage }} {{'Qty' | trans}}: {{ character.equipment.hand_off.quantity }}
                                    {% elif character.equipment.hand_off.category == 'Weapon' %}
                                        {{'Dmg' | trans}}: {{ character.equipment.hand_off.damage }}
                                    {% elif character.equipment.hand_off.category == 'Ammo' %}
                                        {{'Qty' | trans}}: {{ character.equipment.hand_off.quantity }}
                                    {% else %}
                                        {{'Def' | trans}}: {{ character.equipment.hand_off.defense }}
                                    {% endif %}
                                </div>
                            </div>
                            {% if is_owner or is_gm %}
                            <form action="/characters/{{ character._id }}/unequip" method="POST">
                                <input type="hidden" name="slot" value="off">
                                <button class="btn-text">‚úï</button>
                            </form>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="empty-slot">{{ 'Empty' | trans }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- ROW 2: BODY & MOUNT -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                
                <!-- ARMOR -->
                <div class="equip-slot">
                    <small>{{ 'Armor' | trans }}</small>
                    {% if character.equipment.armor %}
                        <div class="item-box">
                            <div>
                                <strong>{{ character.equipment.armor.name }}</strong>
                                <div style="font-size: 0.7rem;">Def: {{ character.equipment.armor.defense }}</div>
                            </div>
                            {% if is_owner or is_gm %}
                            <form action="/characters/{{ character._id }}/unequip" method="POST">
                                <input type="hidden" name="slot" value="armor">
                                <button class="btn-text">‚úï</button>
                            </form>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="empty-slot">{{ 'Empty' | trans }}</div>
                    {% endif %}
                </div>

                <!-- HORSE -->
                <div class="equip-slot">
                    <small>{{ 'Horse' | trans }}</small>
                    {% if character.equipment.horse %}
                        <div class="item-box">
                            <div>
                                <strong>{{ character.equipment.horse.name }}</strong>
                                <div style="font-size: 0.7rem;">+{{ character.equipment.horse.carry_bonus_kg }}kg {{ 'Load' | trans }}</div>
                            </div>
                            {% if is_owner or is_gm %}
                            <form action="/characters/{{ character._id }}/unequip" method="POST">
                                <input type="hidden" name="slot" value="horse">
                                <button class="btn-text">‚úï</button>
                            </form>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="empty-slot">{{ 'Empty' | trans }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- INVENTORY SECTION -->
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="border-bottom: 2px solid var(--ink); margin: 0;">{{ 'Inventory' | trans }}</h3>
            {% if is_gm %}
            <button onclick="document.getElementById('addItemModal').style.display='block'" class="btn btn-small">
                + {{ 'GM Add Item' | trans }}
            </button>
            {% endif %}
        </div>

        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem;">
            <tr style="border-bottom: 1px solid var(--ink);">
                <th style="text-align: left;">{{ 'Name' | trans }}</th>
                <th>{{ 'Qty' | trans }}</th>
                <th>{{ 'Wgt' | trans }}</th>
                <th style="text-align: right;">{{ 'Actions' | trans }}</th>
            </tr>
            {% for item in character.inventory %}
            <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                <td>
                    <strong>{{ item.name }}</strong>
                    <div style="font-size: 0.75rem; color: #666;">{{ item.category | trans }} / {{ item.weapon_type | trans }}</div>
                </td>
                <td style="text-align: center;">{{ item.quantity }}</td>
                <td style="text-align: center;">{{ item.weight }}</td>
                <td style="text-align: right;">
                    {% if is_owner or is_gm %}
                    <div style="display: flex; gap: 5px; justify-content: flex-end;">
                        
                        <!-- EQUIP LOGIC -->
                        <form action="/characters/{{ character._id }}/equip" method="POST">
                            <input type="hidden" name="item_id" value="{{ item.id }}">
                            
                            {% if item.category == 'Armor' %}
                                <input type="hidden" name="slot" value="armor">
                                <button class="btn btn-small">{{ 'Equip' | trans }}</button>
                            {% elif item.category == 'Horse' %}
                                <input type="hidden" name="slot" value="horse">
                                <button class="btn btn-small">{{ 'Equip' | trans }}</button>
                            {% elif item.category in ['Weapon', 'Ammo'] %}
                                <!-- Choose Hand -->
                                <button name="slot" value="main" class="btn btn-small" title="Main Hand">{{ 'Main' | trans }}</button>
                                <button name="slot" value="off" class="btn btn-small" title="Off Hand">{{ 'Off' | trans }}</button>
                            {% endif %}
                        </form>

                        <!-- DELETE (GM ONLY) -->
                        {% if is_gm %}
                        <form action="/characters/{{ character._id }}/inventory/delete" method="POST" onsubmit="return confirm('GM: Delete item?');">
                            <input type="hidden" name="item_id" value="{{ item.id }}">
                            <button class="btn btn-small" style="background: #8a3324;">üóë</button>
                        </form>
                        {% endif %}
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr><td colspan="4" style="text-align: center; padding: 1rem;">{{ 'Bag is empty.' | trans }}</td></tr>
            {% endfor %}
        </table>
    </div>

    <!-- END GRID -->
</div>

    
<!-- FIEFS & BUSINESS SECTION -->
<div style="margin-top: 3rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--ink); margin-bottom: 1rem;">
        <h3>{{ 'Fiefs & Enterprises' | trans }}</h3>
        {% if is_gm %}
        <button onclick="document.getElementById('fiefModal').style.display='block'" class="btn btn-small">
            + {{ 'Add Fief' | trans }}
        </button>
        {% endif %}
    </div>

    <table style="width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.4);">
        <tr style="background: rgba(0,0,0,0.1);">
            <th style="text-align: left; padding: 10px;">{{ 'Name' | trans }}</th>
            <th style="padding: 10px;">{{ 'Type' | trans }}</th>
            <th style="padding: 10px;">{{ 'Income' | trans }}</th>
            <th style="text-align: right; padding: 10px;">{{ 'Actions' | trans }}</th>
        </tr>
        {% for fief in character.fiefs %}
        <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
            <td style="padding: 10px;"><strong>{{ fief.name }}</strong></td>
            <td style="text-align: center;">{{ fief.type }}</td>
            <td style="text-align: center; color: #c5a004; font-weight: bold;">+{{ fief.income }}</td>
            <td style="text-align: right; padding: 10px;">
                {% if is_gm %}
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <!-- COLLECT -->
                    <form action="/characters/{{ character._id }}/fiefs/collect" method="POST">
                        <input type="hidden" name="fief_id" value="{{ fief.id }}">
                        <button class="btn btn-small" title="Add income to Gold">üí∞ {{ 'Collect' | trans }}</button>
                    </form>
                    <!-- DELETE -->
                    <form action="/characters/{{ character._id }}/fiefs/delete" method="POST" onsubmit="return confirm('{{ 'Destroy this fief?' | trans }}');">
                        <input type="hidden" name="fief_id" value="{{ fief.id }}">
                        <button class="btn btn-small" style="background: #8a3324;">‚úï</button>
                    </form>
                </div>
                {% else %}
                <span style="opacity: 0.5;">-</span>
                {% endif %}
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="4" style="text-align: center; padding: 1.5rem; font-style: italic; opacity: 0.7;">
                {{ 'This character owns no lands or businesses.' | trans }}
            </td>
        </tr>
        {% endfor %}
    </table>
</div>

<!-- BOTTOM SECTION: PRIVATE NOTES -->
{% if is_owner or is_gm %}
<div style="margin-top: 3rem; border-top: 3px solid var(--ink); padding-top: 1rem;">
    <h3>üìú {{ 'Private Notes & Journals' | trans }}</h3>
    <form action="/characters/{{ character._id }}/notes" method="POST">
        <textarea name="notes" rows="8"
            style="width: 100%; background: rgba(255,255,255,0.5); font-family: 'Courier New', monospace; padding: 1rem; border: 1px dashed var(--accent);">{{ character.private_notes }}</textarea>
        <div style="text-align: right; margin-top: 10px;">
            <button type="submit" class="btn">{{ 'Save Notes' | trans }}</button>
        </div>
    </form>
</div>
{% endif %}

<!-- Updated GM Add Item Modal -->
<div id="addItemModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
    <div style="background: var(--parchment); width: 90%; max-width: 500px; margin: 5vh auto; padding: 2rem; border: 2px solid var(--ink);">
        <h3>{{ 'GM Item Creator' | trans }}</h3>
        <form action="/characters/{{ character._id }}/inventory/add" method="POST">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label>{{ 'Name' | trans }}</label>
                    <input type="text" name="name" required placeholder="{{ 'e.g.: Longsword' | trans}}">
                </div>
                <div>
                     <label>{{ 'Category' | trans }}</label>
                    <select name="category" required onchange="updateFormLayout()">
                        <option value="General">{{ 'General' | trans }}</option>
                        <option value="Weapon">{{ 'Weapon' | trans }}</option>
                        <option value="Armor">{{ 'Armor' | trans }}</option>
                        <option value="Horse">{{ 'Horse' | trans }}</option>
                        <option value="Ammo">{{ 'Ammo' | trans }}</option>
                    </select>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                <div><label>{{ 'Weight (kg)' | trans }}</label><input type="number" step="0.1" name="weight" value="1.0"></div>
                <div><label>{{ 'Quantity' | trans }}</label><input type="number" name="qty" value="1"></div>
            </div>

            <!-- Weapon Logic (Hidden for Ammo) -->
            <div id="weaponTypeFields" style="display: none; border: 1px dashed #666; padding: 10px; margin-top: 10px;">
                <strong>{{ 'Weapon Class' | trans }}</strong>
                <select name="weapon_type" onchange="updateWeaponLogic()">
                    <option value="None">{{ 'None' | trans }}</option>
                    <option value="One-Handed">{{ 'One-Handed' | trans }}</option>
                    <option value="Two-Handed">{{ 'Two-Handed' | trans }}</option>
                    <option value="Polearm">{{ 'Polearm' | trans }}</option>
                    <option value="Bow">{{ 'Bow' | trans }}</option>
                    <option value="Crossbow">{{ 'Crossbow' | trans }}</option>
                    <option value="Throwing">{{ 'Throwing' | trans }}</option>
                    <option value="Shield">{{ 'Shield' | trans }}</option>
                </select>
                
                <div style="margin-top:5px; background: rgba(0,0,0,0.05); padding: 5px;">
                    <label style="cursor: pointer;">
                        <input type="checkbox" name="is_two_handed" id="cbTwoHanded" value="true"> 
                        {{ 'Is Two-Handed?' | trans }}
                    </label>
                    <div style="font-size: 0.7rem; color: #666;">{{ '(Auto-set by Type)' | trans }}</div>
                </div>
            </div>

            <!-- Damage Stats (Visible for Weapon AND Ammo) -->
            <div id="damageFields" style="display: none; border: 1px dashed #666; padding: 10px; margin-top: 10px;">
                <strong>{{ 'Offensive Stats' | trans }}</strong>
                <div>
                    <label>{{ 'Damage' | trans }}</label>
                    <input type="number" name="damage" value="0">
                </div>
            </div>

            <!-- Defense Stats (Visible for Armor AND Weapon) -->
            <div id="defenseFields" style="display: none; border: 1px dashed #666; padding: 10px; margin-top: 10px;">
                <strong>{{ 'Defensive Stats' | trans }}</strong>
                <div><label>{{ 'Defense' | trans }}</label><input type="number" name="defense" value="0"></div>
            </div>

            <!-- Horse Stats -->
            <div id="horseFields" style="display: none; border: 1px dashed #666; padding: 10px; margin-top: 10px;">
                <strong>{{ 'Mount Stats' | trans }}</strong>
                <div><label>{{ 'Max Carry Bonus (kg)' | trans }}</label><input type="number" name="carry_bonus" value="0"></div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn" style="flex: 1;">{{ 'Grant Item' | trans }}</button>
                <button type="button" onclick="document.getElementById('addItemModal').style.display='none'" class="btn" style="background: #666;">{{ 'Cancel' | trans }}</button>
            </div>
        </form>
    </div>
</div>

    
<!-- MODAL: Change Photo -->
<div id="photoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="background: var(--parchment); width: 300px; margin: 20vh auto; padding: 1.5rem; border: 2px solid var(--ink);">
        <h3>{{ 'Portrait URL' | trans }}</h3>
        <form action="/characters/{{ character._id }}/image" method="POST">
            <input type="text" name="image_url" placeholder="{{ 'https://...' | trans }}" value="{{ character.image_url }}" required style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="flex: 1">{{ 'Save' | trans }}</button>
                <button type="button" onclick="document.getElementById('photoModal').style.display='none'" class="btn" style="background: #666;">{{ 'Cancel' | trans }}</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: Edit Gold (GM) -->
<div id="goldModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="background: var(--parchment); width: 300px; margin: 20vh auto; padding: 1.5rem; border: 2px solid var(--ink);">
        <h3>{{ 'Treasury' | trans }}</h3>
        <form action="/characters/{{ character._id }}/gold/update" method="POST">
            <label>{{ 'Set Total Gold Amount:' | trans }}</label>
            <input type="number" name="amount" value="{{ character.status.gold }}" required style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="flex: 1">{{ 'Update' | trans }}</button>
                <button type="button" onclick="document.getElementById('goldModal').style.display='none'" class="btn" style="background: #666;">{{ 'Cancel' | trans }}</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: Add Fief (GM) -->
<div id="fiefModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="background: var(--parchment); width: 350px; margin: 20vh auto; padding: 1.5rem; border: 2px solid var(--ink);">
        <h3>{{ 'Grant Fief / Enterprise' | trans }}</h3>
        <form action="/characters/{{ character._id }}/fiefs/add" method="POST">
            <label>{{ 'Name' | trans }}</label>
            <input type="text" name="name" placeholder="Greenwood Mill" required>
            
            <label>{{ 'Type' | trans }}</label>
            <select name="type" required style="margin-bottom: 10px;">
                <option value="Caravan">{{ 'Caravan' | trans }}</option>
                <option value="Workshop">{{ 'Workshop' | trans }}</option>
                <option value="Trade Ship">{{ 'Trade Ship' | trans }}</option>
                <option value="Village">{{ 'Village' | trans }}</option>
                <option value="City">{{ 'City' | trans }}</option>
                <option value="Castle">{{ 'Castle' | trans }}</option>
            </select>
            
            <label>{{ 'Weekly Income (Gold)' | trans }}</label>
            <input type="number" name="income" value="100" required style="margin-bottom: 1rem;">
            
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="flex: 1">{{ 'Grant' | trans }}</button>
                <button type="button" onclick="document.getElementById('fiefModal').style.display='none'" class="btn" style="background: #666;">{{ 'Cancel' | trans }}</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal for Status -->
<div id="statusModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="background: var(--parchment); width: 300px; margin: 20vh auto; padding: 1.5rem; border: 2px solid var(--ink);">
        <h3>{{ 'Update Status' | trans }}</h3>
        <form action="/characters/{{ character._id }}/status/update" method="POST">
            
            <label>{{ 'Current HP (Max: ' | trans }}{{ character.status.hp_max }})</label>
            <input type="number" name="hp_current" value="{{ character.status.hp_current }}" required style="margin-bottom: 1rem;">

            <label>{{ 'Current Stamina (Max: ' | trans }}{{ max_stamina }})</label>
            <input type="number" name="stamina_current" value="{{ character.status.stamina }}" required style="margin-bottom: 1rem;">
            
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="flex: 1">{{ 'Update' | trans }}</button>
                <button type="button" onclick="document.getElementById('statusModal').style.display='none'" class="btn" style="background: #666;">{{ 'Cancel' | trans }}</button>
            </div>
        </form>
    </div>
</div>

    
<!-- MODAL: Public Bio -->
<div id="bioModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="background: var(--parchment); width: 80%; max-width: 600px; margin: 15vh auto; padding: 2rem; border: 2px solid var(--ink); box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative;">
        <button onclick="document.getElementById('bioModal').style.display='none'" 
                style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
        
        <h2 style="margin-top: 0; border-bottom: 2px solid var(--ink);">{{ 'Biography' | trans }}</h2>
        <div style="white-space: pre-wrap; font-family: 'Georgia', serif; line-height: 1.6; max-height: 60vh; overflow-y: auto;">
            {{ character.public_bio }}
        </div>
        
        {% if is_owner or is_gm %}
        <div style="text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--ink);">
            <button onclick="document.getElementById('bioModal').style.display='none'; document.getElementById('editBioModal').style.display='block';" 
                    class="btn btn-small">
                ‚úèÔ∏è {{ 'Edit Biography' | trans }}
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- MODAL: Edit Bio -->
<div id="editBioModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001;">
    <div style="background: var(--parchment); width: 80%; max-width: 600px; margin: 10vh auto; padding: 2rem; border: 2px solid var(--ink); box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative;">
        <button onclick="document.getElementById('editBioModal').style.display='none'" 
                style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
        
        <h2 style="margin-top: 0; border-bottom: 2px solid var(--ink);">{{ 'Edit Biography' | trans }}</h2>
        <form action="/characters/{{ character._id }}/bio" method="POST">
            <textarea name="public_bio" rows="12"
                style="width: 100%; background: rgba(255,255,255,0.5); font-family: 'Georgia', serif; padding: 1rem; border: 1px solid var(--accent); resize: vertical;">{{ character.public_bio }}</textarea>
            <div style="display: flex; gap: 10px; margin-top: 1rem;">
                <button type="submit" class="btn" style="flex: 1;">{{ 'Save Biography' | trans }}</button>
                <button type="button" onclick="document.getElementById('editBioModal').style.display='none'" class="btn" style="background: #666;">{{ 'Cancel' | trans }}</button>
            </div>
        </form>
    </div>
</div>

<!-- Extra Styles for this section -->
<style>
    .equip-slot {
        background: rgba(0, 0, 0, 0.05);
        border: 1px dashed #8b7d6b;
        padding: 5px;
        min-height: 40px;
    }

    .empty-slot {
        color: #999;
        text-align: center;
        padding-top: 5px;
        font-size: 0.8rem;
    }

    .item-box {
        background: var(--ink);
        color: var(--parchment);
        padding: 5px;
        font-size: 0.85rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .btn-text {
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
        font-weight: bold;
    }

    .btn-text:hover {
        color: var(--accent);
    }
</style>
</div>

<script>
    // Initial Server Data
    const INITIAL_POOL = {{ character.points.attribute_points }};
    let currentPool = INITIAL_POOL;

    // --- Attributes Logic ---
    function toggleEdit() {
        document.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'block');
        document.getElementById('editBtn').style.display = 'none';
        updateUI();
    }

    function cancelEdit() {
        document.querySelectorAll('input[type="hidden"]').forEach(input => {
            input.value = input.dataset.original;
            document.getElementById('display-' + input.name).innerText = input.value;
        });
        currentPool = INITIAL_POOL;
        document.querySelectorAll('.view-mode').forEach(el => el.style.display = 'inline');
        document.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'none');
        const editBtn = document.getElementById('editBtn');
        if (editBtn) editBtn.style.display = 'inline-block';
    }

    function adjustStat(attrName, delta) {
        const input = document.getElementById('input-' + attrName);
        const display = document.getElementById('display-' + attrName);
        let currentVal = parseInt(input.value);
        let originalVal = parseInt(input.dataset.original);

        if (delta === 1) {
            if (currentPool <= 0) return;
            if (currentVal >= 20) return;
            currentVal++;
            currentPool--;
        } else if (delta === -1) {
            if (currentVal <= originalVal) return;
            currentVal--;
            currentPool++;
        }
        input.value = currentVal;
        display.innerText = currentVal;
        updateUI();
    }

    function updateUI() {
        const uiPoints = document.getElementById('ui-points-remaining');
        if(uiPoints) uiPoints.innerText = currentPool;

        const allPlusBtns = document.querySelectorAll('[id^="btn-plus-"]');
        allPlusBtns.forEach(btn => {
            if (currentPool <= 0) {
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
            } else {
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            }
        });
        const confirmBtn = document.getElementById('confirmBtn');
        if(confirmBtn) confirmBtn.disabled = (currentPool < 0);
    }

    // --- GM Item Modal Logic ---

    function updateFormLayout() {
        const cat = document.querySelector('select[name="category"]').value;
        
        // 1. Weapon Logic (Type & Hands): Only for strict "Weapon"
        // Fix: Use correct ID 'weaponTypeFields'
        const weaponTypeDiv = document.getElementById('weaponTypeFields');
        if(weaponTypeDiv) weaponTypeDiv.style.display = (cat === 'Weapon') ? 'block' : 'none';
        
        // 2. Damage: Weapon OR Ammo
        const damageDiv = document.getElementById('damageFields');
        if(damageDiv) damageDiv.style.display = (cat === 'Weapon' || cat === 'Ammo') ? 'block' : 'none';

        // 3. Defense: Armor OR Weapon
        const defenseDiv = document.getElementById('defenseFields');
        if(defenseDiv) defenseDiv.style.display = (cat === 'Armor' || cat === 'Weapon') ? 'block' : 'none';
        
        // 4. Horse: Only Horse
        const horseDiv = document.getElementById('horseFields');
        if(horseDiv) horseDiv.style.display = (cat === 'Horse') ? 'block' : 'none';

        if (cat === 'Weapon') {
            updateWeaponLogic();
        }
    }

    function updateWeaponLogic() {
        const type = document.querySelector('select[name="weapon_type"]').value;
        const cb = document.getElementById('cbTwoHanded');
        
        const forcedTwoHanded = ['Two-Handed'];
        
        if (forcedTwoHanded.includes(type)) {
            cb.checked = true;
            cb.style.accentColor = "#666"; 
            cb.onclick = function() { return false; }; 
        } else {
            cb.checked = false;
            cb.style.accentColor = null; 
            cb.onclick = function() { return false; }; 
        }
    }

    function openStatusModal() {
        document.getElementById('statusModal').style.display = 'block';
    }
</script>

{% endblock %}